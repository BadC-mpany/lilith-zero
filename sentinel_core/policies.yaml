# Sentinel Policy Configuration
# This file defines API key permissions, upstream servers, and security rules.

# --- Customer & API Key Definitions ---
customers:
  # This key is for the demonstration agent.
  - api_key: "sk_live_demo_123"
    owner: "Demo User"
    # The hidden upstream URL for the MCP server. The agent does not know this.
    mcp_upstream_url: "http://mcp_server:9000"
    # The policy identifier to apply to this key.
    policy_name: "default_policy"

# --- Policy Definitions ---
policies:
  - name: "default_policy"
    # --- STATIC RULES (ACL) ---
    # Defines a simple ALLOW/DENY for specific tools.
    # If a tool is not listed, it is implicitly denied.
    static_rules:
      read_file: ALLOW
      web_search: ALLOW
      delete_db: DENY

    # --- DYNAMIC RULES (Taint Logic) ---
    # Supports both tool-name-based and class-based rules, plus patterns.
    taint_rules:
      # Simple rule: Tool-name-based
      # Reading any file adds a 'sensitive_data' taint
      - tool: read_file
        action: ADD_TAINT
        tag: "sensitive_data"

      # Simple rule: Class-based
      # Any tool with CONSEQUENTIAL_WRITE class is blocked if session has sensitive_data taint
      - tool_class: CONSEQUENTIAL_WRITE
        action: CHECK_TAINT
        forbidden_tags: ["sensitive_data"]
        error: "Exfiltration Blocked: Cannot use external communication tools after accessing sensitive files."

      # Pattern-based rule: Sequence detection
      # Block if SENSITIVE_READ followed by CONSEQUENTIAL_WRITE
      - pattern:
          type: sequence
          steps:
            - class: SENSITIVE_READ
            - class: CONSEQUENTIAL_WRITE
          max_distance: null # Any distance apart
        action: BLOCK_SECOND
        error: "Security Policy: Direct exfiltration pattern detected (read sensitive â†’ external write)."

      # Pattern-based rule: Logic condition
      # Block any HUMAN_VERIFY tools if session has accessed sensitive data
      - pattern:
          type: logic
          condition:
            AND:
              - session_has_class: SENSITIVE_READ
              - current_tool_class: HUMAN_VERIFY
        action: BLOCK_CURRENT
        error: "Security Policy: Cannot perform destructive operations after accessing sensitive data."

  - name: "read_only_policy"
    static_rules:
      read_file: ALLOW
      web_search: DENY
      delete_db: DENY
    taint_rules:
      # Even in read-only mode, track that files were read
      - tool: read_file
        action: ADD_TAINT
        tag: "data_accessed"
