version: '3.8'

services:
  redis:
    image: "redis:7-alpine"
    hostname: redis
    ports:
      - "6379:6379"
    command: ["redis-server", "--appendonly", "no"] # Changed to 'no' for ephemeral local dev, persist for production
    volumes:
      - redis_data:/data # Named volume for persistence (optional for local dev)
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 1s
      timeout: 3s
      retries: 5
    networks:
      - sentinel-net

  interceptor:
    build:
      context: .
      dockerfile: Dockerfile.interceptor # Will create this Dockerfile
    ports:
      - "8000:8000"
    environment:
      - SENTINEL_URL=http://interceptor:8000 # Inter-service communication
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0 # For Interceptor's taint tracking
      - INTERCEPTOR_PRIVATE_KEY_PATH=/app/secrets/interceptor_private.pem
      - POLICIES_YAML_PATH=/app/policies.yaml
    volumes:
      - ./secrets:/app/secrets:ro # Mount secrets as read-only
      - ./policies.yaml:/app/policies.yaml:ro # Mount policies.yaml as read-only
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - sentinel-net

  mcp_server:
    build:
      context: .
      dockerfile: Dockerfile.mcp # Will create this Dockerfile
    ports:
      - "9000:9000"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=1 # For MCP's nonce "burn list"
      - MCP_PUBLIC_KEY_PATH=/app/secrets/mcp_public.pem
    volumes:
      - ./secrets:/app/secrets:ro # Mount secrets as read-only
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - sentinel-net

volumes:
  redis_data:

networks:
  sentinel-net:
    driver: bridge
