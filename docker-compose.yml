version: '3.8'

services:
  redis:
    image: "redis:7-alpine"
    hostname: redis
    ports:
      - "6379:6379"
    command: ["redis-server", "--appendonly", "no"]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 1s
      timeout: 3s
      retries: 5
    networks:
      - sentinel-net

  interceptor:
    build:
      context: .
      dockerfile: sentinel_core/interceptor/python/Dockerfile
    ports:
      - "8000:8000"
    environment:
      - SENTINEL_URL=http://interceptor:8000
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - INTERCEPTOR_PRIVATE_KEY_PATH=/app/secrets/interceptor_private.pem
      - POLICIES_YAML_PATH=/app/policies.yaml
    volumes:
      - ./sentinel_core/secrets:/app/secrets:ro
      - ./sentinel_core/policies.yaml:/app/policies.yaml:ro
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - sentinel-net

  mcp_server:
    build:
      context: .
      dockerfile: sentinel_core/mcp/Dockerfile
    ports:
      - "9000:9000"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=1
      - MCP_PUBLIC_KEY_PATH=/app/secrets/mcp_public.pem
    volumes:
      - ./sentinel_core/secrets:/app/secrets:ro
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - sentinel-net

volumes:
  redis_data:

networks:
  sentinel-net:
    driver: bridge
