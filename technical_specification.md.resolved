# Sentinel: MCP Security Middleware

**Technical Specification v1.0**

---

## 1. Overview

Sentinel is a security middleware for the [Model Context Protocol (MCP)](https://spec.modelcontextprotocol.io/specification/2024-11-05/). It interposes between an MCP client (e.g., Claude Desktop, LangChain agent) and an upstream MCP tool server, enforcing access control, taint tracking, and prompt injection defenses.

### 1.1 Architecture

```mermaid
graph LR
    subgraph "Application Layer"
        A[LLM Agent]
    end
    subgraph "Python SDK"
        B[SentinelClient]
    end
    subgraph "Rust Middleware (stdio JSON-RPC)"
        C[McpMiddleware]
        D[PolicyEvaluator]
        E[CryptoSigner]
        F[SecurityEngine]
    end
    subgraph "Upstream"
        G[MCP Tool Server]
    end

    A --> B
    B -- "JSON-RPC 2.0 over stdio" --> C
    C --> D
    C --> E
    C --> F
    C -- "JSON-RPC 2.0 over stdio" --> G
```

### 1.2 Key Properties

| Property | Implementation |
|----------|----------------|
| Transport | stdio (newline-delimited JSON-RPC 2.0) |
| Session Integrity | HMAC-SHA256 signed session IDs |
| Access Control | Static ACL + dynamic taint rules |
| Prompt Injection Defense | Randomized spotlighting delimiters |
| Process Isolation | Windows Job Objects / Unix `PR_SET_PDEATHSIG` |
| Observability | Structured JSON audit logs to stderr |

---

## 2. Rust Middleware

**Location:** `sentinel/src/`  
**Entry Point:** `main.rs`  
**Binary:** `sentinel.exe` (Windows) / `sentinel` (Unix)

### 2.1 Module Structure

```
sentinel/src/
├── main.rs          # CLI entry point, tokio runtime
├── lib.rs           # Public module exports
├── config.rs        # Environment-based configuration
├── constants.rs     # All magic numbers and protocol constants
├── core/
│   ├── auth.rs      # JWT audience binding validation
│   ├── crypto.rs    # HMAC-SHA256 session ID generation
│   ├── errors.rs    # Domain error types with HTTP mappings
│   └── models.rs    # PolicyDefinition, Decision, HistoryEntry
├── engine/
│   ├── evaluator.rs # Policy evaluation (static + taint rules)
│   └── pattern_matcher.rs # Condition evaluation (MVP stub)
├── mcp/
│   ├── server.rs    # McpMiddleware main loop
│   ├── transport.rs # StdioTransport (bounded reads)
│   ├── process.rs   # ProcessSupervisor (lifecycle binding)
│   └── security.rs  # Spotlighting engine
└── utils/
    ├── audit_logger.rs # Structured JSON audit to stderr
    └── time.rs         # Timestamp utility
```

### 2.2 CLI Interface

```bash
sentinel --upstream-cmd <COMMAND> [--policy <PATH>] -- [UPSTREAM_ARGS...]
```

| Argument | Required | Description |
|----------|----------|-------------|
| `--upstream-cmd` | Yes | Command to spawn the upstream MCP server |
| `--policy` | No | Path to policy YAML file |
| `--` | No | Separator for upstream arguments |

**Environment Variables:**

| Variable | Default | Description |
|----------|---------|-------------|
| `POLICIES_YAML_PATH` | None | Fallback policy path |
| `LOG_LEVEL` | `info` | Tracing filter (`debug`, `info`, `warn`, `error`) |
| `LOG_FORMAT` | `text` | Output format (`text` or `json`) |
| `SENTINEL_OWNER` | `unknown` | Owner identifier for audit logs |
| `SENTINEL_EXPECTED_AUDIENCE` | None | Comma-separated list for JWT audience binding |

### 2.3 Core Types

#### 2.3.1 McpMiddleware

**File:** [server.rs](file:///c:/Users/Peter/Documents/proj/active/bad/sentinel/sentinel/src/mcp/server.rs)

```rust
pub struct McpMiddleware {
    transport: StdioTransport,           // Client-facing I/O
    upstream: Option<ProcessSupervisor>, // Child process handle
    upstream_stdin: Option<ChildStdin>,  // Write to upstream
    upstream_stdout: Option<BufReader<ChildStdout>>,
    session_id: String,                  // HMAC-signed session ID
    signer: CryptoSigner,                // Ephemeral HMAC key
    history: Vec<HistoryEntry>,          // Call history for taint rules
    taints: HashSet<String>,             // Active session taints
    policy: Option<PolicyDefinition>,    // Loaded policy
}
```

**Request Handling Flow:**

1. `initialize` → Spawn upstream, perform MCP handshake, validate audience binding
2. `tools/list` → Validate session, forward to upstream
3. `tools/call` → Validate session, evaluate policy, execute or block, apply spotlighting

#### 2.3.2 PolicyDefinition

**File:** [models.rs](file:///c:/Users/Peter/Documents/proj/active/bad/sentinel/sentinel/src/core/models.rs)

```rust
pub struct PolicyDefinition {
    pub id: String,
    pub customer_id: String,
    pub name: String,
    pub version: u32,
    pub static_rules: HashMap<String, String>,  // tool_name → "ALLOW"|"DENY"
    pub taint_rules: Vec<PolicyRule>,           // Dynamic rules
    pub created_at: String,
}
```

**YAML Schema:**

```yaml
id: "my-policy"
customer_id: "customer-123"
name: "Production Policy"
version: 1
staticRules:
  read_database: "ALLOW"
  delete_user: "DENY"
taintRules:
  - tool: "read_database"
    action: "ADD_TAINT"
    tag: "PII"
  - tool: "send_email"
    action: "CHECK_TAINT"
    forbidden_tags: ["PII"]
    error: "Cannot send email with PII data"
created_at: "2026-01-01T00:00:00Z"
```

#### 2.3.3 Decision

```rust
pub enum Decision {
    Allowed,
    Denied { reason: String },
    AllowedWithSideEffects {
        taints_to_add: Vec<String>,
        taints_to_remove: Vec<String>,
    },
}
```

### 2.4 Security Mechanisms

#### 2.4.1 Session Integrity

**File:** [crypto.rs](file:///c:/Users/Peter/Documents/proj/active/bad/sentinel/sentinel/src/core/crypto.rs)

Session IDs are cryptographically signed to prevent forgery:

```
Format: "{version}.{uuid_b64}.{hmac_sha256_b64}"
Example: "1.0OfeWj0Rn0SWH+hNg74bAQ.5K1J2..."
```

The HMAC key is ephemeral (generated per process). Validation uses constant-time comparison.

#### 2.4.2 Spotlighting

**File:** [security.rs](file:///c:/Users/Peter/Documents/proj/active/bad/sentinel/sentinel/src/mcp/security.rs)

Wraps tool outputs with randomized delimiters to prevent prompt injection:

```
<<<SENTINEL_DATA_START:aB3xK7pQ>>>
<actual tool output>
<<<SENTINEL_DATA_END:aB3xK7pQ>>>
```

The 8-character ID is randomly generated per response, making it unpredictable.

#### 2.4.3 Process Isolation

**File:** [process.rs](file:///c:/Users/Peter/Documents/proj/active/bad/sentinel/sentinel/src/mcp/process.rs)

| Platform | Mechanism |
|----------|-----------|
| Windows | Job Object with `JOB_OBJECT_LIMIT_KILL_ON_JOB_CLOSE` |
| Linux | `prctl(PR_SET_PDEATHSIG, SIGKILL)` before exec |

This ensures the upstream process is terminated if Sentinel crashes or is killed.

#### 2.4.4 DoS Protection

**File:** [transport.rs](file:///c:/Users/Peter/Documents/proj/active/bad/sentinel/sentinel/src/mcp/transport.rs)

Maximum message size enforced at 10 MB (`MAX_MESSAGE_SIZE_BYTES`).

### 2.5 Audit Logging

**File:** [audit_logger.rs](file:///c:/Users/Peter/Documents/proj/active/bad/sentinel/sentinel/src/utils/audit_logger.rs)

Structured JSON logs emitted to stderr:

```json
{
  "timestamp": 1706396400.123,
  "session_id": "1.abc...",
  "event_type": "Decision",
  "tool": "read_database",
  "decision": "ALLOWED_WITH_SIDE_EFFECTS",
  "details": {"taints_added": ["PII"]}
}
```

**Event Types:** `SessionStart`, `ToolCall`, `Decision`, `TaintViolation`, `SystemError`

---

## 3. Python SDK

**Location:** `sentinel_sdk/`  
**Package:** `sentinel_sdk`  
**Version:** 0.1.0

### 3.1 Module Structure

```
sentinel_sdk/
├── __init__.py      # Public API (Sentinel, SentinelClient)
├── src/
│   ├── sentinel_sdk.py  # SentinelClient implementation
│   ├── constants.py     # SDK constants
│   └── prompts.py       # LLM system prompts
└── pyproject.toml
```

### 3.2 Public API

#### 3.2.1 Sentinel (Facade)

**File:** [__init__.py](file:///c:/Users/Peter/Documents/proj/active/bad/sentinel/sentinel_sdk/__init__.py)

```python
from sentinel_sdk import Sentinel

client = Sentinel.start(
    upstream="python tools.py",  # Upstream command
    policy="policy.yaml",        # Optional policy path
    security_level="high",       # "low", "medium", "high"
    binary_path=None             # Optional explicit binary path
)

async with client:
    result = await client.execute_tool("my_tool", {"arg": "value"})
```

**Security Levels:**

| Level | Spotlighting | Strict Taint | Session Validation |
|-------|--------------|--------------|-------------------|
| `low` | Off | Off | Off |
| `medium` | On | Off | On |
| `high` | On | On | On |

#### 3.2.2 SentinelClient

**File:** [sentinel_sdk.py](file:///c:/Users/Peter/Documents/proj/active/bad/sentinel/sentinel_sdk/src/sentinel_sdk.py)

```python
class SentinelClient:
    async def start_session(self) -> None
    async def stop_session(self) -> None
    async def get_tools_config(self) -> List[Dict[str, Any]]
    async def execute_tool(self, tool_name: str, args: Dict[str, Any]) -> Any
    async def get_langchain_tools(self) -> List[StructuredTool]
```

**Session Lifecycle:**

1. `start_session()` spawns Sentinel binary as subprocess
2. SDK captures `SENTINEL_SESSION_ID=...` from stderr
3. SDK sends `initialize` → `notifications/initialized`
4. All subsequent requests include `_sentinel_session_id` in params
5. `stop_session()` terminates the subprocess

### 3.3 LangChain Integration

```python
from sentinel_sdk import Sentinel

client = Sentinel.start(upstream="python tools.py")

async with client:
    tools = await client.get_langchain_tools()
    # Returns List[langchain_core.tools.StructuredTool]
```

The SDK automatically:
- Fetches tool schemas from `tools/list`
- Creates Pydantic models for each tool's `inputSchema`
- Wraps execution through Sentinel

---

## 4. Wire Protocol

### 4.1 Transport

- **Stream:** Newline-delimited JSON over stdio
- **Protocol:** JSON-RPC 2.0
- **Max Message Size:** 10 MB

### 4.2 Message Flow

```mermaid
sequenceDiagram
    participant SDK as Python SDK
    participant MW as Sentinel Middleware
    participant UP as Upstream Server

    Note over MW: Prints "SENTINEL_SESSION_ID=..."
    SDK->>MW: initialize {protocolVersion, clientInfo}
    MW->>UP: initialize {...}
    UP-->>MW: {capabilities}
    MW-->>SDK: {capabilities}
    
    SDK->>MW: notifications/initialized {}
    
    SDK->>MW: tools/list {_sentinel_session_id}
    MW->>UP: tools/list {}
    UP-->>MW: {tools: [...]}
    MW-->>SDK: {tools: [...]}
    
    SDK->>MW: tools/call {name, arguments, _sentinel_session_id}
    Note over MW: Policy Evaluation
    alt Allowed
        MW->>UP: tools/call {name, arguments}
        UP-->>MW: {content: [...]}
        Note over MW: Apply Spotlighting
        MW-->>SDK: {content: [...]}  (spotlighted)
    else Denied
        MW-->>SDK: {error: {code: -32000, message: "..."}}
    end
```

### 4.3 Error Codes

| Code | Meaning |
|------|---------|
| `-32000` | Security block (policy violation) |
| `-32001` | Authentication error (session invalid) |
| `-32600` | Invalid request |
| `-32601` | Method not found |
| `-32603` | Internal error |
| `-32700` | Parse error |

---

## 5. Policy Evaluation

### 5.1 Evaluation Order

1. **Static Rules (ACL):** Check `static_rules[tool_name]`. If `"DENY"`, reject immediately.
2. **Taint Rules:** For each rule in `taint_rules`:
   - If `action == "CHECK_TAINT"` and any `forbidden_tags` are present in session taints → deny (unless exception matches)
   - If `action == "ADD_TAINT"` → queue taint to add
   - If `action == "REMOVE_TAINT"` → queue taint to remove
   - If `action == "BLOCK"` → deny

3. **Return Decision:**
   - If any denials occurred → `Denied { reason }`
   - If taints modified → `AllowedWithSideEffects { taints_to_add, taints_to_remove }`
   - Otherwise → `Allowed`

### 5.2 Tool Classification

Currently uses prefix-based auto-classification:
- `read_*`, `get_*` → `["READ"]`
- `write_*`, `delete_*` → `["WRITE"]`

---

## 6. Configuration Reference

### 6.1 Rust Constants

**File:** [constants.rs](file:///c:/Users/Peter/Documents/proj/active/bad/sentinel/sentinel/src/constants.rs)

| Module | Constant | Value |
|--------|----------|-------|
| `jsonrpc` | `ERROR_SECURITY_BLOCK` | `-32000` |
| `jsonrpc` | `ERROR_AUTH` | `-32001` |
| `crypto` | `SECRET_KEY_LENGTH` | `32` |
| `spotlight` | `RANDOM_ID_LENGTH` | `8` |
| `limits` | `MAX_MESSAGE_SIZE_BYTES` | `10 * 1024 * 1024` |
| `session` | `SESSION_ID_PARAM` | `"_sentinel_session_id"` |

### 6.2 Python Constants

**File:** [constants.py](file:///c:/Users/Peter/Documents/proj/active/bad/sentinel/sentinel_sdk/src/constants.py)

| Constant | Value |
|----------|-------|
| `MCP_PROTOCOL_VERSION` | `"2024-11-05"` |
| `SESSION_TIMEOUT_SEC` | `5.0` |
| `SESSION_POLL_INTERVAL_SEC` | `0.1` |
| `DEFAULT_SECURITY_LEVEL` | `"high"` |

---

## 7. Error Handling

### 7.1 InterceptorError

**File:** [errors.rs](file:///c:/Users/Peter/Documents/proj/active/bad/sentinel/sentinel/src/core/errors.rs)

| Variant | HTTP Code | User-Facing Message |
|---------|-----------|---------------------|
| `InvalidApiKey` | 401 | "Invalid API Key" |
| `AuthenticationError` | 401 | "Authentication failed: {reason}" |
| `ValidationError` | 400 | "Validation failed: {reason}" |
| `PolicyViolation` | 403 | "Policy violation: {reason}" |
| `InfrastructureError` | 503 | "Service unavailable" |
| `DependencyFailure` | 503 | "Service unavailable" |

---

## 8. Build and Deployment

### 8.1 Rust Build

```bash
cd sentinel
cargo build --release
# Binary: target/release/sentinel(.exe)
```

### 8.2 Python Install

```bash
cd sentinel_sdk
pip install -e .
```

### 8.3 Binary Discovery

The SDK searches for the binary in this order:
1. `SENTINEL_BINARY_PATH` environment variable
2. System `PATH`
3. Relative paths: `sentinel/target/release/`, `target/release/`, `./`

---

## Appendix A: Files Summary

| Component | File | Lines | Purpose |
|-----------|------|-------|---------|
| **Rust** | `main.rs` | 107 | CLI, tokio runtime |
| | `server.rs` | 479 | Main middleware loop |
| | `transport.rs` | 108 | Bounded stdio I/O |
| | `process.rs` | 102 | Process lifecycle binding |
| | `crypto.rs` | 90 | HMAC session IDs |
| | `evaluator.rs` | 147 | Policy evaluation |
| | `models.rs` | 189 | Domain types |
| | `errors.rs` | 112 | Error types |
| **Python** | `sentinel_sdk.py` | 353 | Client implementation |
| | `__init__.py` | 187 | Public facade |
| | `constants.py` | 91 | SDK constants |

**Total Rust LOC:** ~1,800  
**Total Python LOC:** ~630
