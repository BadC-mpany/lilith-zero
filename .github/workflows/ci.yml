name: Sentinel CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # --------------------------------------------------------------------------
  # Rust Core Validation (Windows & Linux)
  # --------------------------------------------------------------------------
  rust-core:
    name: Rust Core (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache Cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            sentinel/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Format Check
        run: cd sentinel && cargo fmt --all -- --check

      - name: Clippy (Linting)
        run: cd sentinel && cargo clippy --all-targets --all-features -- -D warnings

      - name: Examples Check (Sandbox)
        run: cd sentinel && cargo check --examples

      - name: Tests
        run: cd sentinel && cargo test --all-features

      - name: Build Release
        run: cd sentinel && cargo build --release

      - name: Upload Binary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sentinel-${{ matrix.os }}
          path: |
            sentinel/target/release/sentinel
            sentinel/target/release/sentinel.exe
          if-no-files-found: ignore

  # --------------------------------------------------------------------------
  # Python SDK Validation
  # --------------------------------------------------------------------------
  python-sdk:
    name: Python SDK
    runs-on: ubuntu-latest
    needs: [rust-core] # Wait for Rust, though conceptually independent
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy pytest pytest-asyncio
          if [ -f sentinel_sdk/requirements.txt ]; then pip install -r sentinel_sdk/requirements.txt; fi
          # Install SDK in editable mode
          pip install -e sentinel_sdk/

      - name: Ruff (Linting)
        run: ruff check sentinel_sdk --ignore E501

      - name: Mypy (Type Checking)
        run: mypy sentinel_sdk/src --ignore-missing-imports

      - name: Init Test (Unit Only)
        # Skip integration tests that require the binary being present
        run: python -m pytest tests --ignore=tests/test_basic_flow.py --ignore=tests/test_security_hardening.py

  # --------------------------------------------------------------------------
  # Integration Tests (Windows)
  # --------------------------------------------------------------------------
  integration-windows:
    name: Integration (Windows)
    runs-on: windows-latest
    needs: [rust-core] # Needs binary
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download Windows Binary
        uses: actions/download-artifact@v4
        with:
          name: sentinel-windows-latest
          path: sentinel/target/release

      - name: Install SDK & Deps
        run: |
          python -m pip install --upgrade pip
          pip install -e sentinel_sdk/
          pip install pytest pytest-asyncio

      - name: Run Integration Tests
        env:
          SENTINEL_BINARY_PATH: sentinel/target/release/sentinel.exe
          RUST_LOG: info
        run: |
          python -m pytest tests/test_basic_flow.py tests/test_security_hardening.py
