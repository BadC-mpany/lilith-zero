name: Main CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # --------------------------------------------------------------------------
  # 1. Quality & Supply Chain Security
  # --------------------------------------------------------------------------
  quality-rust:
    uses: ./.github/workflows/_quality_rust.yml
    permissions:
      contents: read

  quality-python:
    uses: ./.github/workflows/_quality_python.yml
    permissions:
      contents: read

  docs-check:
    uses: ./.github/workflows/_docs.yml
    permissions:
      contents: read
    with:
      deploy: false

  # --------------------------------------------------------------------------
  # 2. Comprehensive Testing Matrix
  # --------------------------------------------------------------------------
  test-matrix:
    needs: [quality-rust, quality-python]
    uses: ./.github/workflows/_test.yml
    permissions:
      contents: read
    with:
      cargo_profile: release # Use release profile for tests in CI to catch optim-bugs

  # --------------------------------------------------------------------------
  # 3. Build Verification (Dry Run)
  # --------------------------------------------------------------------------
  build-dry-run:
    needs: [test-matrix]
    uses: ./.github/workflows/_build.yml
    permissions:
      contents: read
    with:
      retention-days: 1 # Short retention for PR builds
