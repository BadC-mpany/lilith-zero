name: Matrix Tests

on:
  workflow_call:
    inputs:
      cargo_profile:
        required: false
        type: string
        default: release

permissions:
  contents: read

jobs:
  # --------------------------------------------------------------------------
  # Rust Core Tests (Matrix)
  # --------------------------------------------------------------------------
  test-core:
    name: Rust Core (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          persist-credentials: false

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@400e7407cfd7a091e5fbb6afec01ec146c432b7c # v2.7.3
        with:
          workspaces: lilith-zero -> target

      - name: Unit Tests
        working-directory: lilith-zero
        run: cargo test --locked --all-features --${{ inputs.cargo_profile }}

  # --------------------------------------------------------------------------
  # Miri Undefined Behavior Check (Nightly)
  # --------------------------------------------------------------------------
  miri:
    name: Miri (UB Check)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout Repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          persist-credentials: false

      - name: Install Miri Toolchain
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7
        with:
          toolchain: nightly
          components: miri

      - name: Rust Cache
        uses: Swatinem/rust-cache@400e7407cfd7a091e5fbb6afec01ec146c432b7c # v2.7.3
        with:
          workspaces: lilith-zero -> target

      - name: Run Miri
        working-directory: lilith-zero
        env:
          # Allow IO for time/randomness, disabling strict isolation where safe
          MIRIFLAGS: "-Zmiri-disable-isolation"
        run: cargo miri test --locked

  # --------------------------------------------------------------------------
  # Python SDK Integration Tests (Matrix)
  # --------------------------------------------------------------------------
  test-sdk:
    name: SDK (Py${{ matrix.python }})
    runs-on: ubuntu-latest
    needs: [test-core] # Wait for core tests to pass first
    strategy:
      fail-fast: false
      matrix:
        python: ["3.10", "3.11", "3.12"]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          persist-credentials: false

      - name: Install Python ${{ matrix.python }}
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: ${{ matrix.python }}

      - name: Install uv
        uses: astral-sh/setup-uv@4db96194c378173c656ce18a155ffc14a9fc4355 # v5.1.0
        with:
          enable-cache: true
          # Unique cache key per python version
          cache-suffix: sdk-${{ matrix.python }}

      - name: Install SDK & Tests
        working-directory: sdk
        run: |
          uv pip install --system .[dev] pytest pytest-asyncio pyjwt

      - name: Run SDK Tests
        working-directory: sdk
        run: pytest -v
